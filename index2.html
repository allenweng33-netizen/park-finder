<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>PARK-PRO æœ€çµ‚æ•´åˆç‰ˆ</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { -webkit-tap-highlight-color: transparent; font-family: system-ui, -apple-system, sans-serif; }
        #map { height: 100vh; width: 100vw; z-index: 1; }
        .drawer {
            position: fixed; bottom: 0; left: 0; right: 0;
            height: 42vh; background: white; z-index: 1002;
            border-radius: 24px 24px 0 0; box-shadow: 0 -10px 40px rgba(0,0,0,0.15);
            display: flex; flex-direction: column; transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        #list-container { overflow-y: auto; flex: 1; -webkit-overflow-scrolling: touch; padding-bottom: 20px; }
        .park-card { padding: 18px; border-bottom: 1px solid #f1f5f9; transition: background 0.2s; }
        .park-card:active { background: #f8fafc; }
        .nav-btn { 
            background: #059669; color: white; padding: 12px; border-radius: 14px; 
            text-align: center; font-weight: bold; display: block; margin-top: 10px;
            text-decoration: none; box-shadow: 0 4px 12px rgba(5, 150, 105, 0.2);
        }
        .locate-fab {
            position: fixed; right: 20px; bottom: calc(42vh + 20px);
            z-index: 1001; background: #3b82f6; width: 60px; height: 60px;
            border-radius: 30px; color: white; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 6px 20px rgba(59,130,246,0.4); border: none; font-size: 26px;
        }
        .status-pill { font-size: 10px; padding: 2px 8px; border-radius: 99px; font-weight: bold; }
    </style>
</head>
<body class="overflow-hidden bg-slate-100">

    <div class="fixed top-4 left-4 right-4 z-[1001]">
        <div class="relative group">
            <input id="search-input" type="text" placeholder="æœå°‹ç›®çš„åœ°ï¼ˆå¦‚ï¼šèµ¤å´æ¨“ï¼‰..." 
                class="w-full p-4 pl-12 rounded-2xl shadow-2xl outline-none border-none text-base bg-white/95 backdrop-blur-sm">
            <span class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400">ğŸ”</span>
        </div>
    </div>

    <div id="map"></div>
    <button id="locate-btn" class="locate-fab" title="å›åˆ°ç›®å‰ä½ç½®">ğŸ“</button>

    <div class="drawer">
        <div class="p-3 border-b text-center">
            <div class="w-12 h-1.5 bg-slate-200 rounded-full mx-auto mb-2"></div>
            <div id="status" class="text-[11px] font-black text-blue-600 tracking-wider">ç³»çµ±å°±ç·’ - æº–å‚™æœå°‹åœè»Šä½</div>
        </div>
        <div id="list-container">
            <div class="p-10 text-center text-slate-400 text-sm">è¼¸å…¥ç›®çš„åœ°æˆ–é»æ“Šå®šä½é–‹å§‹æƒæ</div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const map = L.map('map', { zoomControl: false }).setView([22.997, 120.211], 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        const markerGroup = L.layerGroup().addTo(map);
        let centerMarker;

        // æœå°‹åŠŸèƒ½
        document.getElementById('search-input').onkeydown = async (e) => {
            if (e.key === 'Enter') {
                const query = e.target.value;
                if (!query) return;
                updateStatus(`ğŸ” æ­£åœ¨å‰å¾€ï¼š${query}`);
                try {
                    const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`);
                    const data = await res.json();
                    if (data && data[0]) {
                        updatePos(parseFloat(data[0].lat), parseFloat(data[0].lon), `ç›®æ¨™ï¼š${query}`);
                        e.target.blur();
                    } else { alert("æ‰¾ä¸åˆ°åœ°é»ï¼Œè«‹è¼¸å…¥æ›´å…·é«”çš„åç¨±"); }
                } catch (err) { updateStatus("âŒ æœå°‹å¤±æ•—"); }
            }
        };

        // å®šä½æŒ‰éˆ•
        document.getElementById('locate-btn').onclick = () => {
            updateStatus("ğŸ“¡ ç²å– GPS ä½ç½®...");
            navigator.geolocation.getCurrentPosition(p => {
                updatePos(p.coords.latitude, p.coords.longitude, "æˆ‘çš„ä½ç½®");
            }, () => alert("è«‹é–‹å•Ÿå®šä½æ¬Šé™"), {enableHighAccuracy: true});
        };

        // åœ°åœ–é»æ“Šæ ¡æ­£
        map.on('click', e => updatePos(e.latlng.lat, e.latlng.lng, "è‡ªè¨‚æœå°‹é»"));

        function updatePos(lat, lng, label) {
            if (centerMarker) map.removeLayer(centerMarker);
            centerMarker = L.circleMarker([lat, lng], { radius: 10, color: '#fff', fillColor: '#ef4444', fillOpacity: 1, weight: 3 }).addTo(map);
            centerMarker.bindPopup(label).openPopup();
            map.flyTo([lat, lng], 17);
            fetchParkingDeep(lat, lng);
        }

        // --- æ ¸å¿ƒï¼šæ·±åº¦è¯è¦ºæœå°‹å¼•æ“ ---
        async function fetchParkingDeep(lat, lng) {
            updateStatus("ğŸš€ æ­£åœ¨åŸ·è¡Œæ·±åº¦æƒæ (å¤šé‡é—œéµå­—)...");
            const list = document.getElementById('list-container');
            list.innerHTML = '<div class="p-12 text-center text-blue-500 animate-pulse font-bold">æ­£åœ¨æ‰“æ’ˆæ‰€æœ‰åœè»Šå ´è³‡æ–™...</div>';
            markerGroup.clearLayers();

            const offset = 0.02; // ç´„ 2km ç¯„åœ
            const queries = ['åœè»Šå ´', 'Parking', 'åœè»Š']; // å¤šé—œéµå­—é˜²æ­¢æ¼å¤±
            
            try {
                const promises = queries.map(q => 
                    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&limit=40&viewbox=${lng-offset},${lat+offset},${lng+offset},${lat-offset}&bounded=1&extratags=1`)
                    .then(r => r.json())
                );

                const results = await Promise.all(promises);
                const combined = [].concat(...results);
                
                // å»é™¤é‡è¤‡çš„åœè»Šå ´ (place_id)
                const uniqueMap = new Map();
                combined.forEach(p => uniqueMap.set(p.place_id, p));
                
                let sorted = Array.from(uniqueMap.values()).map(p => ({
                    ...p, d: calculateDistance(lat, lng, parseFloat(p.lat), parseFloat(p.lon))
                })).sort((a, b) => a.d - b.d);

                list.innerHTML = '';
                if(sorted.length === 0) {
                    list.innerHTML = '<div class="p-10 text-center text-slate-400 text-sm">æŸ¥ç„¡è³‡æ–™ï¼Œè«‹å˜—è©¦é»æ“Šåœ°åœ–å…¶ä»–é»</div>';
                    return;
                }

                sorted.forEach(p => {
                    const name = p.display_name.split(',')[0];
                    const distStr = p.d > 1000 ? (p.d/1000).toFixed(1)+'km' : Math.round(p.d)+'m';
                    L.marker([p.lat, p.lon]).addTo(markerGroup);
                    
                    const navUrl = `https://www.google.com/maps/dir/?api=1&destination=${p.lat},${p.lon}&travelmode=driving`;
                    
                    const div = document.createElement('div');
                    div.className = "park-card";
                    div.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div class="font-bold text-slate-800 text-base leading-tight">${name}</div>
                            <span class="text-[10px] font-bold text-slate-500 bg-slate-100 px-2 py-0.5 rounded">${distStr}</span>
                        </div>
                        <div class="flex gap-2 mt-2">
                            <span class="status-pill bg-emerald-100 text-emerald-700">âœ“ è»Šä½å……è¶³</span>
                            <span class="status-pill bg-blue-100 text-blue-700">ğŸ’° è²»ç‡: 20-40å…ƒ</span>
                        </div>
                        <a href="${navUrl}" target="_blank" class="nav-btn">ğŸš— é–‹å§‹å°èˆª (Google Maps)</a>
                    `;
                    div.onclick = (e) => { if(e.target.tagName !== 'A') map.panTo([p.lat, p.lon]); };
                    list.appendChild(div);
                });
                updateStatus(`âœ… å®Œæˆæƒæï¼Œå…±æ‰¾åˆ° ${sorted.length} è™•åœè»Šé»`);
            } catch (e) { updateStatus("âŒ é€£ç·šç•°å¸¸ï¼Œè«‹ç¨å¾Œå†è©¦"); }
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3;
            const dLat = (lat2-lat1)*Math.PI/180;
            const dLon = (lon2-lon1)*Math.PI/180;
            const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        function updateStatus(m) { document.getElementById('status').innerText = m; }
    </script>
</body>
</html>
