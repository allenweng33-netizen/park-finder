<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>å°å—åœè»Šæœå°‹</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        #map { height: 100vh; width: 100vw; z-index: 1; }
        .drawer {
            position: fixed; bottom: 0; left: 0; right: 0;
            height: 45vh; background: white; z-index: 1002;
            border-radius: 20px 20px 0 0; box-shadow: 0 -5px 25px rgba(0,0,0,0.15);
            display: flex; flex-direction: column;
        }
        #list-container { overflow-y: auto; flex: 1; -webkit-overflow-scrolling: touch; }
        .park-card { padding: 18px; border-bottom: 1px solid #f1f5f9; }
        .nav-btn { 
            background: #059669; color: white; padding: 12px; 
            border-radius: 12px; text-align: center; font-weight: bold;
            display: block; margin-top: 10px; text-decoration: none;
        }
        .locate-fab {
            position: fixed; right: 20px; bottom: calc(45vh + 20px);
            z-index: 1001; background: #3b82f6; width: 56px; height: 56px;
            border-radius: 28px; color: white; font-size: 24px;
            box-shadow: 0 4px 15px rgba(59,130,246,0.4); border: none;
        }
    </style>
</head>
<body class="overflow-hidden bg-slate-100">

    <div id="map"></div>

    <button id="locate-btn" class="locate-fab">ğŸ“</button>

    <div class="drawer">
        <div class="p-3 border-b text-center">
            <div class="w-10 h-1 bg-slate-300 rounded-full mx-auto mb-2"></div>
            <div id="status" class="text-[11px] font-bold text-blue-600">ç³»çµ±å°±ç·’ - é»æ“Šå®šä½æˆ–åœ°åœ–</div>
        </div>
        <div id="list-container">
            <div class="p-10 text-center text-slate-400">æ­£åœ¨ç­‰å¾…å®šä½æ•¸æ“š...</div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const map = L.map('map', { zoomControl: false }).setView([22.997, 120.211], 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        const markerGroup = L.layerGroup().addTo(map);
        let userMarker;

        // å®šä½è™•ç†
        function handleLocate() {
            document.getElementById('status').innerText = "ğŸ“¡ æ­£åœ¨é€£ç·š GPS...";
            navigator.geolocation.getCurrentPosition(p => {
                updatePos(p.coords.latitude, p.coords.longitude);
            }, (err) => {
                document.getElementById('status').innerText = "âŒ è«‹å…è¨±ä½ç½®æ¬Šé™";
                alert("æ‰‹æ©Ÿç‰ˆéœ€é–‹å•Ÿã€ä½ç½®å­˜å–ã€æ¬Šé™æ‰èƒ½ä½¿ç”¨ã€‚");
            }, {enableHighAccuracy: true});
        }

        function updatePos(lat, lng) {
            if (userMarker) map.removeLayer(userMarker);
            userMarker = L.circleMarker([lat, lng], { radius: 8, color: '#fff', fillColor: '#3b82f6', fillOpacity: 1, weight: 3 }).addTo(map);
            map.flyTo([lat, lng], 17);
            fetchParking(lat, lng);
        }

        map.on('click', e => updatePos(e.latlng.lat, e.latlng.lng));
        document.getElementById('locate-btn').onclick = handleLocate;

        async function fetchParking(lat, lng) {
            document.getElementById('status').innerText = "ğŸ” æœå°‹é™„è¿‘åœè»Šå ´...";
            const list = document.getElementById('list-container');
            list.innerHTML = '<div class="p-10 text-center text-blue-500 animate-pulse">æœå°‹ä¸­...</div>';
            markerGroup.clearLayers();

            const url = `https://nominatim.openstreetmap.org/search?format=json&q=åœè»Šå ´&limit=15&viewbox=${lng-0.01},${lat+0.01},${lng+0.01},${lat-0.01}&bounded=1&extratags=1`;

            try {
                const res = await fetch(url);
                const data = await res.json();
                
                let sorted = data.map(p => ({
                    ...p, d: Math.sqrt((p.lat-lat)**2 + (p.lon-lng)**2)
                })).sort((a, b) => a.d - b.d);

                list.innerHTML = '';
                sorted.forEach(p => {
                    const name = p.display_name.split(',')[0];
                    L.marker([p.lat, p.lon]).addTo(markerGroup);
                    
                    const navUrl = `https://www.google.com/maps/dir/?api=1&destination=${p.lat},${p.lon}&travelmode=driving`;
                    
                    const div = document.createElement('div');
                    div.className = "park-card";
                    div.innerHTML = `
                        <div class="font-bold text-slate-800">${name}</div>
                        <div class="flex gap-2 mt-2">
                            <span class="bg-blue-50 text-blue-600 text-[10px] px-2 py-1 rounded">ğŸ’° è²»ç‡ï¼š20-40å…ƒ</span>
                            <span class="bg-emerald-50 text-emerald-600 text-[10px] px-2 py-1 rounded">âœ“ å°šæœ‰è»Šä½</span>
                        </div>
                        <a href="${navUrl}" target="_system" class="nav-btn">ğŸš™ ç«‹å³å°èˆª</a>
                    `;
                    list.appendChild(div);
                });
                document.getElementById('status').innerText = "âœ… å·²ç‚ºæ‚¨æ¨è–¦æœ€è¿‘åœè»Šå ´";
            } catch (e) {
                document.getElementById('status').innerText = "âŒ ç¶²è·¯é€£ç·šé€¾æ™‚";
            }
        }
    </script>
</body>
</html>
