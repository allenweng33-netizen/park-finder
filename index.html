<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>PARK-PRO | å®šä½ä¿®å¾©ç‰ˆ</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { -webkit-tap-highlight-color: transparent; }
        #map { height: 100vh; width: 100vw; z-index: 1; }
        .drawer {
            position: fixed; bottom: 0; left: 0; right: 0;
            height: 42vh; background: white; z-index: 1002;
            border-radius: 24px 24px 0 0; box-shadow: 0 -10px 40px rgba(0,0,0,0.15);
            display: flex; flex-direction: column;
        }
        #list-container { overflow-y: auto; flex: 1; padding-bottom: 20px; }
        .park-card { padding: 18px; border-bottom: 1px solid #f1f5f9; }
        .nav-btn { 
            background: #059669; color: white; padding: 12px; border-radius: 12px; 
            text-align: center; font-weight: bold; display: block; margin-top: 10px;
        }
        .locate-fab {
            position: fixed; right: 20px; bottom: calc(42vh + 20px);
            z-index: 1001; background: #3b82f6; width: 56px; height: 56px;
            border-radius: 28px; color: white; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 15px rgba(59,130,246,0.4); border: none; font-size: 24px;
        }
    </style>
</head>
<body class="overflow-hidden bg-slate-100">

    <div class="fixed top-4 left-4 right-4 z-[1001]">
        <div class="relative flex items-center shadow-2xl">
            <input id="search-input" type="text" placeholder="GPSå¤±æ•ˆæ™‚è«‹ç›´æ¥è¼¸å…¥ç›®çš„åœ°" 
                class="w-full p-4 pl-12 rounded-2xl outline-none border-none text-base bg-white">
            <span class="absolute left-4">ğŸ”</span>
            <button id="search-go" class="absolute right-2 bg-blue-600 text-white px-4 py-2 rounded-xl text-sm font-bold">æœå°‹</button>
        </div>
    </div>

    <div id="map"></div>
    <button id="locate-btn" class="locate-fab">ğŸ“</button>

    <div class="drawer">
        <div class="p-3 border-b text-center">
            <div class="w-12 h-1 bg-slate-200 rounded-full mx-auto mb-2"></div>
            <div id="status" class="text-[11px] font-black text-red-600 uppercase">ç­‰å¾…å®šä½æˆæ¬Š...</div>
        </div>
        <div id="list-container">
            <div class="p-10 text-center text-slate-400 text-sm">è‹¥å®šä½ç„¡æ•ˆï¼Œè«‹é»æ“Šä¸Šæ–¹æœå°‹æ¡†è¼¸å…¥åœ°é»</div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const map = L.map('map', { zoomControl: false }).setView([22.997, 120.211], 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        const markerGroup = L.layerGroup().addTo(map);
        let centerMarker;

        // å®šä½é‚è¼¯å‡ç´šï¼šåŠ å…¥è¶…æ™‚è™•ç†èˆ‡æç¤º
        function handleLocate() {
            updateStatus("ğŸ“¡ æ­£åœ¨å˜—è©¦å•Ÿå‹• GPS...");
            const options = {
                enableHighAccuracy: true,
                timeout: 8000, // 8ç§’æ²’åæ‡‰å°±å ±éŒ¯
                maximumAge: 0
            };

            navigator.geolocation.getCurrentPosition(
                (p) => {
                    updateStatus("âœ… å®šä½æˆåŠŸ");
                    updatePos(p.coords.latitude, p.coords.longitude, "ç›®å‰ä½ç½®");
                },
                (err) => {
                    let msg = "å®šä½å¤±æ•—ï¼šè«‹æª¢æŸ¥ç€è¦½å™¨æ¬Šé™";
                    if(err.code === 1) msg = "âŒ è«‹å…è¨±ä½ç½®å­˜å–æ¬Šé™";
                    if(err.code === 3) msg = "âŒ GPS è¨Šè™Ÿéå¼±ï¼Œè«‹è‡³çª—é‚Š";
                    updateStatus(msg);
                    alert(msg + "ã€‚æ‚¨å¯ä»¥æ‰‹å‹•è¼¸å…¥åœ°å€é€²è¡Œæœå°‹ã€‚");
                }, 
                options
            );
        }

        window.onload = handleLocate;
        document.getElementById('locate-btn').onclick = handleLocate;

        // æœå°‹åŠŸèƒ½å‚™æ´
        async function runSearch() {
            const query = document.getElementById('search-input').value.trim();
            if (!query) return;
            try {
                const refinedQuery = query.includes("å°å—") ? query : `å°å— ${query}`;
                const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(refinedQuery)}&limit=1`);
                const data = await res.json();
                if (data && data[0]) {
                    updatePos(parseFloat(data[0].lat), parseFloat(data[0].lon), query);
                    document.getElementById('search-input').blur();
                }
            } catch (err) { updateStatus("âŒ æœå°‹æš«æ™‚ä¸å¯ç”¨"); }
        }

        document.getElementById('search-go').onclick = runSearch;
        document.getElementById('search-input').onkeydown = e => { if(e.key==='Enter') runSearch(); };

        function updatePos(lat, lng, label) {
            if (centerMarker) map.removeLayer(centerMarker);
            centerMarker = L.circleMarker([lat, lng], { radius: 10, color: '#fff', fillColor: '#ef4444', fillOpacity: 1, weight: 3 }).addTo(map);
            map.flyTo([lat, lng], 17);
            fetchParking(lat, lng);
        }

        async function fetchParking(lat, lng) {
            updateStatus("ğŸ” æœå°‹å‘¨é‚Šä¸­...");
            const list = document.getElementById('list-container');
            list.innerHTML = '<div class="p-10 text-center text-blue-500 font-bold animate-pulse">ç²¾ç¢ºè¨ˆç®—æ’åºä¸­...</div>';
            markerGroup.clearLayers();

            const offset = 0.015; 
            const url = `https://nominatim.openstreetmap.org/search?format=json&q=åœè»Šå ´&limit=40&viewbox=${lng-offset},${lat+offset},${lng+offset},${lat-offset}&bounded=1`;

            try {
                const res = await fetch(url);
                const data = await res.json();
                
                let sorted = data.map(p => ({
                    ...p, d: calculateDistance(lat, lng, parseFloat(p.lat), parseFloat(p.lon))
                })).sort((a, b) => a.d - b.d);

                list.innerHTML = '';
                sorted.forEach(p => {
                    const name = p.display_name.split(',')[0];
                    const distStr = p.d > 1000 ? (p.d/1000).toFixed(1)+'km' : Math.round(p.d)+'m';
                    L.marker([p.lat, p.lon]).addTo(markerGroup);
                    const navUrl = `https://www.google.com/maps/dir/?api=1&destination=${p.lat},${p.lon}&travelmode=driving`;
                    
                    const div = document.createElement('div');
                    div.className = "park-card";
                    div.innerHTML = `
                        <div class="flex justify-between items-center">
                            <div class="font-bold text-slate-800 text-base leading-tight">${name}</div>
                            <span class="bg-slate-100 px-2 py-1 rounded text-xs text-slate-500 font-bold">${distStr}</span>
                        </div>
                        <a href="${navUrl}" target="_blank" class="nav-btn">ğŸš™ å°èˆªè‡³æ­¤</a>
                    `;
                    list.appendChild(div);
                });
                updateStatus(`âœ… å·²åˆ—å‡ºæœ€çŸ­è·é›¢åœè»Šå ´`);
            } catch (e) { updateStatus("âŒ ç²å–å¤±æ•—"); }
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3;
            const dLat = (lat2-lat1)*Math.PI/180;
            const dLon = (lon2-lon1)*Math.PI/180;
            const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        function updateStatus(m) { document.getElementById('status').innerText = m; }
    </script>
</body>
</html>
